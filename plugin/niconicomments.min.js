/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/@xpadev-net/niconicomments@0.2.43/dist/bundle.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
/*!
  niconicomments.js v0.2.43
  (c) 2021 xpadev-net https://xpadev.net
  Released under the MIT License.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).NiconiComments=t()}(this,(function(){"use strict";var e={white:"#FFFFFF",red:"#FF0000",pink:"#FF8080",orange:"#FFC000",yellow:"#FFFF00",green:"#00FF00",cyan:"#00FFFF",blue:"#0000FF",purple:"#C000FF",black:"#000000",white2:"#CCCC99",niconicowhite:"#CCCC99",red2:"#CC0033",truered:"#CC0033",pink2:"#FF33CC",orange2:"#FF6600",passionorange:"#FF6600",yellow2:"#999900",madyellow:"#999900",green2:"#00CC66",elementalgreen:"#00CC66",cyan2:"#00CCCC",blue2:"#3399FF",marinblue:"#3399FF",purple2:"#6633CC",nobleviolet:"#6633CC",black2:"#666666"},t=function(e){return"boolean"==typeof e},i=function(e){return"number"==typeof e},n=function(e){return"object"==typeof e},o={formatted:{comment:function(e){return r(e,["id","vpos","content","date","date_usec","owner","premium","mail","user_id","layer"])},comments:function(e){if("object"!=typeof e)return!1;for(var t=0,i=e;t<i.length;t++){var n=i[t];if(!o.formatted.comment(n))return!1}return!0},legacyComment:function(e){return r(e,["id","vpos","content","date","owner","premium","mail"])},legacyComments:function(e){if("object"!=typeof e)return!1;for(var t=0,i=e;t<i.length;t++){var n=i[t];if(!o.formatted.legacyComment(n))return!1}return!0}},legacy:{rawApiResponses:function(e){if("object"!=typeof e)return!1;for(var t=0,i=e;t<i.length;t++)for(var n=i[t],r=0,c=Object.keys(n);r<c.length;r++){var a=n[c[r]];if(a&&!(o.legacy.apiChat(a)||o.legacy.apiGlobalNumRes(a)||o.legacy.apiLeaf(a)||o.legacy.apiPing(a)||o.legacy.apiThread(a)))return!1}return!0},apiChat:function(e){return"object"==typeof e&&r(e,["content","date","no","thread","vpos"])},apiGlobalNumRes:function(e){return r(e,["num_res","thread"])},apiLeaf:function(e){return r(e,["count","thread"])},apiPing:function(e){return r(e,["content"])},apiThread:function(e){return r(e,["resultcode","revision","server_time","thread","ticket"])}},xmlDocument:function(e){if(!e.documentElement||"packet"!==e.documentElement.nodeName)return!1;if(!e.documentElement.children)return!1;for(var t=0;t<e.documentElement.children.length;t++){var i=e.documentElement.children[t];if(i&&("chat"===i.nodeName&&!c(i,["no","vpos","date","date_usec","mail"])))return!1}return!0},legacyOwner:{comments:function(e){if("string"!=typeof e)return!1;for(var t=0,i=e.split("\n");t<i.length;t++){if(i[t].split(":").length<3)return!1}return!0}},owner:{comment:function(e){return r(e,["time","command","comment"])},comments:function(e){if("object"!=typeof e)return!1;for(var t=0,i=e;t<i.length;t++){var n=i[t];if(!o.owner.comment(n))return!1}return!0}},v1:{comment:function(e){return r(e,["id","no","vposMs","body","commands","userId","isPremium","score","postedAt","nicoruCount","nicoruId","source","isMyPost"])},thread:function(e){if(!r(e,["id","fork","commentCount","comments"]))return!1;for(var t=0,i=Object.keys(e.comments);t<i.length;t++){var n=i[t];if(!o.v1.comment(e.comments[n]))return!1}return!0},threads:function(e){if("object"!=typeof e)return!1;for(var t=0,i=e;t<i.length;t++){var n=i[t];if(!o.v1.thread(n))return!1}return!0}},nicoScript:{range:{target:function(e){return"string"==typeof e&&!!e.match(/^(?:\u6295?\u30b3\u30e1|\u5168)$/)}},replace:{range:function(e){return"string"==typeof e&&!!e.match(/^(?:\u5358|\u5168)$/)},target:function(e){return"string"==typeof e&&!!e.match(/^(?:\u30b3\u30e1|\u6295\u30b3\u30e1|\u5168|\u542b\u3080|\u542b\u307e\u306a\u3044)$/)},condition:function(e){return"string"==typeof e&&!!e.match(/^(?:\u90e8\u5206\u4e00\u81f4|\u5b8c\u5168\u4e00\u81f4)$/)}}},comment:{font:function(e){return"string"==typeof e&&!!e.match(/^(?:gothic|mincho|defont)$/)},loc:function(e){return"string"==typeof e&&!!e.match(/^(?:ue|naka|shita)$/)},size:function(e){return"string"==typeof e&&!!e.match(/^(?:big|medium|small)$/)},command:{key:function(e){return"string"==typeof e&&!!e.match(/^(?:full|ender|_live|invisible)$/)}},color:function(t){return"string"==typeof t&&Object.keys(e).includes(t)},colorCode:function(e){return"string"==typeof e&&!!e.match(/^#(?:[0-9a-fA-F]{3,4}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/)}},config:{initOptions:function(e){if("object"!=typeof e||!e)return!1;var o={useLegacy:t,formatted:t,showCollision:t,showFPS:t,showCommentCount:t,drawAllImageOnLoad:t,debug:t,enableLegacyPiP:t,keepCA:t,scale:i,config:n,format:function(e){return"string"==typeof e&&!!e.match(/^(niconicome|formatted|legacy|legacyOwner|owner|v1|default|empty)$/)},video:function(e){return"object"==typeof e&&"VIDEO"===e.nodeName}};for(var r in o)if(void 0!==e[r]&&!o[r](e[r]))return console.warn("[Incorrect input] var: initOptions, key: ".concat(r,", value: ").concat(e[r])),!1;return!0}}},r=function(e,t){if("object"!=typeof e||!e)return!1;for(var i=0,n=t;i<n.length;i++){var o=n[i];if(!Object.prototype.hasOwnProperty.call(e,o))return!1}return!0},c=function(e,t){if("object"!=typeof e||!e)return!1;for(var i=0,n=t;i<n.length;i++){var o=n[i];if(null===e.getAttribute(o))return!1}return!0},a=function(e){for(var t,i=[],n=[],o=0,r=Array.from(e.documentElement.children);o<r.length;o++){var c=r[o];if("chat"===c.nodeName){var a={id:Number(c.getAttribute("no")),vpos:Number(c.getAttribute("vpos")),content:c.innerHTML,date:Number(c.getAttribute("date")),date_usec:Number(c.getAttribute("date_usec")),owner:!c.getAttribute("user_id"),premium:"1"===c.getAttribute("premium"),mail:[],user_id:-1,layer:-1};c.getAttribute("mail")&&(a.mail=(null===(t=c.getAttribute("mail"))||void 0===t?void 0:t.split(/\s+/g))||[]),a.content.startsWith("/")&&a.owner&&a.mail.push("invisible");var s=c.getAttribute("user_id")||"",l=n.indexOf(s);-1===l?(a.user_id=n.length,n.push(s)):a.user_id=l,i.push(a)}}return i},s=function(e){var t=e;if(!o.formatted.comments(e))for(var i=0,n=t;i<n.length;i++){var r=n[i];r.layer=-1,r.user_id=0,r.date_usec||(r.date_usec=0)}return t},l=function(e){for(var t=[],i=[],n=0;n<e.length;n++){var r=e[n];if(r&&o.legacy.apiChat(null==r?void 0:r.chat)){var c=r.chat;if(1!==c.deleted){var a={id:c.no,vpos:c.vpos,content:c.content||"",date:c.date,date_usec:c.date_usec||0,owner:!c.user_id,premium:1===c.premium,mail:[],user_id:-1,layer:-1};c.mail&&(a.mail=c.mail.split(/\s+/g)),c.content.startsWith("/")&&!c.user_id&&a.mail.push("invisible");var s=i.indexOf(c.user_id);-1===s?(a.user_id=i.length,i.push(c.user_id)):a.user_id=s,t.push(a)}}}return t},h=function(e){for(var t=[],i=e.split("\n"),n=0;n<i.length;n++){var o=i[n];if(o){var r=o.split(":");if(!(r.length<3)){if(r.length>3)for(var c=3;c<r.length;c++)r[2]+=":".concat(r[c]);var a={id:n,vpos:Number(r[0]),content:r[2]||"",date:n,date_usec:0,owner:!0,premium:!0,mail:[],user_id:-1,layer:-1};r[1]&&(a.mail=r[1].split(/[\s+]/g)),a.content.startsWith("/")&&a.mail.push("invisible"),t.push(a)}}}return t},m=function(e){var t=[];return e.forEach((function(e,i){var n={id:i,vpos:d(e.time),content:e.comment,date:i,date_usec:0,owner:!0,premium:!0,mail:[],user_id:-1,layer:-1};e.command&&(n.mail=e.command.split(/\s+/g)),n.content.startsWith("/")&&n.mail.push("invisible"),t.push(n)})),t},f=function(e){for(var t=[],i=[],n=0,o=e;n<o.length;n++)for(var r=o[n],c=r.comments,a=r.fork,s=0,l=Object.keys(c);s<l.length;s++){var h=c[l[s]];if(h){var m={id:h.no,vpos:Math.floor(h.vposMs/10),content:h.body,date:g(h.postedAt),date_usec:0,owner:"owner"===a,premium:h.isPremium,mail:h.commands,user_id:-1,layer:-1};m.content.startsWith("/")&&m.owner&&m.mail.push("invisible");var f=i.indexOf(h.userId);-1===f?(m.user_id=i.length,i.push(h.userId)):m.user_id=f,t.push(m)}}return t},u=function(e){return e.sort((function(e,t){return e.vpos<t.vpos?-1:e.vpos>t.vpos?1:e.date<t.date?-1:e.date>t.date?1:e.date_usec<t.date_usec?-1:e.date_usec>t.date_usec?1:0})),e},d=function(e){var t=e.match(/^(?:(\d+):(\d+)\.(\d+)|(\d+):(\d+)|(\d+)\.(\d+)|(\d+))$/);if(t){if(void 0!==t[1]&&void 0!==t[2]&&void 0!==t[3])return 100*(60*Number(t[1])+Number(t[2]))+Number(t[3])/Math.pow(10,t[3].length-2);if(void 0!==t[4]&&void 0!==t[5])return 100*(60*Number(t[4])+Number(t[5]));if(void 0!==t[6]&&void 0!==t[7])return 100*Number(t[6])+Number(t[7])/Math.pow(10,t[7].length-2);if(void 0!==t[8])return 100*Number(t[8])}return 0},g=function(e){return Math.floor(new Date(e).getTime()/1e3)},p=function(){return p=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},p.apply(this,arguments)};function v(e,t,i){if(i||2===arguments.length)for(var n,o=0,r=t.length;o<r;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))}var b,w,z,y=function(e){return e.reduce((function(e,t,i){return 0===i?p({},t):(e.font+=", ".concat(t.font),e)}),{font:"",offset:0,weight:600})},S={arial:{font:'Arial, "ＭＳ Ｐゴシック", "MS PGothic", MSPGothic, MS-PGothic',offset:.01,weight:600},gothic:{font:'"游ゴシック体", "游ゴシック", "Yu Gothic", YuGothic, yugothic, YuGo-Medium',offset:-.04,weight:400},gulim:{font:'Gulim, "黑体", SimHei',offset:.03,weight:400},mincho:{font:'"游明朝体", "游明朝", "Yu Mincho", YuMincho, yumincho, YuMin-Medium',offset:-.01,weight:400},simsun:{font:'"宋体", SimSun',offset:.135,weight:400},macGothicPro6:{font:'"ヒラギノ角ゴ ProN W6", HiraKakuProN-W6, "ヒラギノ角ゴ ProN", HiraKakuProN, "Hiragino Kaku Gothic ProN"',offset:-.05,weight:600},macGothicPro3:{font:'"ヒラギノ角ゴ ProN W3", HiraKakuProN-W3, "ヒラギノ角ゴ ProN", HiraKakuProN, "Hiragino Kaku Gothic ProN"',offset:-.04,weight:300},macMincho:{font:'"ヒラギノ明朝 ProN W3", HiraMinProN-W3, "ヒラギノ明朝 ProN", HiraMinProN, "Hiragino Mincho ProN"',offset:-.02,weight:300},macGothic1:{font:'"ヒラギノ角ゴシック", "Hiragino Sans", HiraginoSans',offset:-.05,weight:600},macGothic2:{font:'"ヒラギノ角ゴシック", "Hiragino Sans", HiraginoSans',offset:-.04,weight:300},sansSerif600:{font:"sans-serif",offset:0,weight:600},sansSerif400:{font:"sans-serif",offset:0,weight:400},serif:{font:"serif",offset:0,weight:400}},x={win7:{defont:y([S.arial]),gothic:y([S.gothic,S.gulim,S.arial]),mincho:y([S.mincho,S.simsun,S.arial])},win8_1:{defont:y([S.arial]),gothic:y([S.gothic,S.simsun,S.arial]),mincho:y([S.mincho,S.simsun,S.arial])},win:{defont:y([S.arial]),gothic:y([S.gulim,S.arial]),mincho:y([S.simsun,S.arial])},mac10_9:{defont:y([S.macGothicPro6]),gothic:y([S.gothic,S.macGothicPro3]),mincho:y([S.mincho,S.macMincho,S.macGothicPro3])},mac10_11:{defont:y([S.macGothic1]),gothic:y([S.gothic,S.macGothic2]),mincho:y([S.mincho,S.macMincho,S.macGothic2])},mac:{defont:y([S.macGothicPro6]),gothic:y([S.macGothicPro3]),mincho:y([S.macMincho])},other:{defont:y([S.sansSerif600]),gothic:y([S.sansSerif400]),mincho:y([S.serif])}},C={config:{},debug:!1,enableLegacyPiP:!1,format:"default",formatted:!1,keepCA:!1,mode:"default",scale:1,showCollision:!1,showCommentCount:!1,showFPS:!1,useLegacy:!1,video:void 0},k={reverse:[],default:[],replace:[],ban:[]},P=function(e,t,i){var n=!1,o=!1;if(!i)return{currentPos:e,isChanged:n,isBreak:o};for(var r=0,c=i;r<c.length;r++){var a=c[r];if(e<a.posY+a.height&&e+t.height>a.posY&&a.owner===t.owner&&a.layer===t.layer&&(a.posY+a.height>e&&(e=a.posY+a.height,n=!0),e+t.height>w.canvasHeight)){e=w.canvasHeight<t.height?t.mail.includes("naka")?(t.height-w.canvasHeight)/-2:0:Math.floor(Math.random()*(w.canvasHeight-t.height)),o=!0;break}}return{currentPos:e,isChanged:n,isBreak:o}},H=function(e,t,i){var n=(w.commentDrawRange+e)/(i+100);return w.commentDrawPadding+w.commentDrawRange-(t+100)*n},O=function(e,t){switch(e){case"gulim":case"simsun":return w.font[e].replace("[size]","".concat(t));case"gothic":case"mincho":return"".concat(w.fonts[e].weight," ").concat(t,"px ").concat(w.fonts[e].font);default:return"".concat(w.fonts.defont.weight," ").concat(t,"px ").concat(w.fonts.defont.font)}},F=function(e,t,i){var n;e||(e={}),e[Number(t)]||(e[Number(t)]=[]),null===(n=e[Number(t)])||void 0===n||n.push(i)},_=function(e){return"#"===e.slice(0,1)&&(e=e.slice(1)),3===e.length&&(e=e.slice(0,1)+e.slice(0,1)+e.slice(1,2)+e.slice(1,2)+e.slice(2,3)+e.slice(2,3)),[e.slice(0,2),e.slice(2,4),e.slice(4,6)].map((function(e){return parseInt(e,16)}))},j=function(e,t){return void 0===t&&(t=!1),Object.prototype.hasOwnProperty.call(e,"html5")&&Object.prototype.hasOwnProperty.call(e,"flash")?e[t?"flash":"html5"]:e},A=function(e){return"flash"===z.mode||"default"===z.mode&&!(e.mail.includes("gothic")||e.mail.includes("defont")||e.mail.includes("mincho"))&&(e.date<w.flashThreshold||e.mail.includes("nico:flash"))},M=function(e){var t=A(e),i=R(e),n=e.content.match(/^(?:@|\uff20)(\u30c7\u30d5\u30a9\u30eb\u30c8|\u7f6e\u63db|\u9006|\u30b3\u30e1\u30f3\u30c8\u7981\u6b62|\u30b7\u30fc\u30af\u7981\u6b62|\u30b8\u30e3\u30f3\u30d7)/);if(n&&e.owner){var r=e.content.match(/^(?:@|\uff20)\u9006(?:\s+)?(\u5168|\u30b3\u30e1|\u6295\u30b3\u30e1)?/),c=e.content.split(""),a=[],s="",l="",h="";if("デフォルト"===n[1])k.default.unshift({start:e.vpos,long:void 0===i.long?void 0:Math.floor(100*i.long),color:i.color,size:i.size,font:i.font,loc:i.loc});else if("逆"===n[1]&&r&&r[1]&&o.nicoScript.range.target(r[1]))void 0===i.long&&(i.long=30),k.reverse.unshift({start:e.vpos,end:e.vpos+100*i.long,target:r[1]});else if("コメント禁止"===n[1])void 0===i.long&&(i.long=30),k.ban.unshift({start:e.vpos,end:e.vpos+100*i.long});else if("置換"===n[1]){for(var m=0,f=c.slice(4);m<f.length;m++){(b=f[m]).match(/["'\u300c]/)&&""===s?s=b:b.match(/["']/)&&s===b&&"\\"!==l?(a.push(h.replaceAll("\\n","\n")),s="",h=""):b.match(/\u300d/)&&"「"===s?(a.push(h),s="",h=""):""===s&&b.match(/\s+/)?h&&(a.push(h),h=""):h+=b,l=b}a.push(h),void 0===a[0]||void 0!==a[2]&&!o.nicoScript.replace.range(a[2])||void 0!==a[3]&&!o.nicoScript.replace.target(a[3])||void 0!==a[4]&&!o.nicoScript.replace.condition(a[4])||(k.replace.unshift({start:e.vpos,long:void 0===i.long?void 0:Math.floor(100*i.long),keyword:a[0],replace:a[1]||"",range:a[2]||"単",target:a[3]||"コメ",condition:a[4]||"部分一致",color:i.color,size:i.size,font:i.font,loc:i.loc,no:e.id}),k.replace.sort((function(e,t){return e.start<t.start?-1:e.start>t.start?1:e.no<t.no?-1:e.no>t.no?1:0})))}i.invisible=!0}for(var u=void 0,d=void 0,g=void 0,v=void 0,b=0;b<k.default.length;b++){if(z=k.default[b])if(void 0!==z.long&&z.start+z.long<e.vpos)k.default=k.default.splice(Number(b),1);else if(z.loc&&(v=z.loc),z.color&&(u=z.color),z.size&&(d=z.size),z.font&&(g=z.font),v&&u&&d&&g)break}for(b=0;b<k.replace.length;b++){var z;(z=k.replace[b])&&(void 0!==z.long&&z.start+z.long<e.vpos?k.default=k.default.splice(Number(b),1):"コメ"===z.target&&e.owner||"投コメ"===z.target&&!e.owner||"含まない"===z.target&&e.owner||("完全一致"===z.condition&&e.content===z.keyword||"部分一致"===z.condition&&-1!==e.content.indexOf(z.keyword))&&("単"===z.range?e.content=e.content.replaceAll(z.keyword,z.replace):e.content=z.replace,z.loc&&(i.loc=z.loc),z.color&&(i.color=z.color),z.size&&(i.size=z.size,i.fontSize=j(w.fontSize,t)[i.size].default),z.font&&(i.font=z.font)))}return i.loc||(i.loc=v||"naka"),i.color||(i.color=u||"#FFFFFF"),i.size||(i.size=d||"medium",i.fontSize=j(w.fontSize,t)[i.size].default),i.font||(i.font=g||"defont"),i.long?i.long=Math.floor(100*Number(i.long)):i.long=300,p(p(p(p({},e),{content:[],lineCount:0,lineOffset:0}),i),{flash:t})},R=function(t){for(var i=t.mail,n=A(t),r={loc:void 0,size:void 0,fontSize:void 0,color:void 0,strokeColor:void 0,font:void 0,full:!1,ender:!1,_live:!1,invisible:!1,long:void 0},c=0,a=i;c<a.length;c++){var s=a[c],l=void 0;if((l=(s=s.toLowerCase()).match(/^(?:@|\uff20)([0-9.]+)/))&&l[1])r.long=Number(l[1]);else if(void 0===r.strokeColor&&(l=s.match(/^nico:stroke:(.+)$/)))o.comment.color(l[1])?r.strokeColor=e[l[1]]:o.comment.colorCode(l[1])&&(r.strokeColor=l[1].slice(1));else if(void 0===r.loc&&o.comment.loc(s))r.loc=s;else if(void 0===r.size&&o.comment.size(s))r.size=s,r.fontSize=j(w.fontSize,n)[s].default;else{if(void 0===r.color){var h=w.colors[s];if(h){r.color=h;continue}var m=s.match(/#[0-9a-z]{3,6}/);if(m&&m[0]&&t.premium){r.color=m[0].toUpperCase();continue}}void 0===r.font&&o.comment.font(s)?r.font=s:o.comment.command.key(s)&&(r[s]=!0)}}return t.content.startsWith("/")&&(r.invisible=!0),r},N=function(e){if(e.strokeColor){var t=e.strokeColor.length;if(3===t||6===t)return"rgba(".concat(_(e.strokeColor).join(","),",").concat(w.contextStrokeOpacity,")");if(4===t||8===t)return"rgba(".concat((i=e.strokeColor,"#"===i.slice(0,1)&&(i=i.slice(1)),4===i.length&&(i=i.slice(0,1)+i.slice(0,1)+i.slice(1,2)+i.slice(1,2)+i.slice(2,3)+i.slice(2,3)+i.slice(3,4)+i.slice(3,4)),[i.slice(0,2),i.slice(2,4),i.slice(4,6),i.slice(4,6)].map((function(e,t){return 3===t?parseInt(e,16)/256:parseInt(e,16)}))).join(","),")")}var i;return"rgba(".concat(_("#000000"===e.color?w.contextStrokeInversionColor:w.contextStrokeColor).join(","),",").concat(w.contextStrokeOpacity,")")},Y=function(e,t,i){void 0===i&&(i=!1);var n=j(w.lineCounts,t),o=j(w.commentStageSize,t),r=o.height/n.doubleResized[e],c=n.default[e];if(i){var a=n.resized[e];return(o.height-r*(c/a))/(a-1)}return(o.height-r)/(c-1)},T=function(e,t){var i=W(e,t);return p(p({},i),{height:e.lineHeight*(e.lineCount-1)+e.charSize})},W=function(e,t){var i=G(e.charSize),n=i.fontSize,o=i.scale,r=[],c=[];t.font=O(e.font,n);for(var a=0,s=0;s<e.content.length;s++){var l=e.content[s];if(void 0!==l){var h=l.content.split("\n");t.font=O(l.font||e.font,n);for(var m=[],f=0;f<h.length;f++){var u=t.measureText(h[f]);a+=u.width,m.push(u.width),f<h.length-1&&(r.push(Math.ceil(a*o)),a=0)}c.push(m),r.push(Math.ceil(a*o))}}return{width:Math.max.apply(Math,r),lineWidth:r,itemWidth:c}},G=function(e){return(e*=.8)<w.minFontSize?(e>=1&&(e=Math.floor(e)),{scale:e/w.minFontSize,fontSize:w.minFontSize}):{scale:1,fontSize:Math.floor(e)}},L={},E=function(){function e(e,t){this.context=t,e.content=e.content.replace(/\t/g,"  "),this.comment=this.getCommentSize(this.parseCommandAndNicoscript(e)),this.posY=0}return Object.defineProperty(e.prototype,"invisible",{get:function(){return this.comment.invisible},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loc",{get:function(){return this.comment.loc},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"long",{get:function(){return this.comment.long},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vpos",{get:function(){return this.comment.vpos},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.comment.width},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.comment.height},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"flash",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"layer",{get:function(){return this.comment.layer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"owner",{get:function(){return this.comment.owner},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mail",{get:function(){return this.comment.mail},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lineCount",{get:function(){return this.comment.lineCount},enumerable:!1,configurable:!0}),e.prototype.parseCommandAndNicoscript=function(e){var t=M(e),i=[];i.push({content:e.content});var n=i.reduce((function(e,t){var i;return e+((null===(i=t.content.match(/\n/g))||void 0===i?void 0:i.length)||0)}),1);return p(p({},t),{content:i,lineCount:n,lineOffset:0})},e.prototype.measureText=function(e){var t,i,n,o,r,c,a=j(w.commentStageSize,!1)[e.full?"fullWidth":"width"],s=j(w.commentScale,!1),l=j(w.fontSize,!1),h=Y(e.size,!1),m=(t=e.size,i=!1,n=j(w.lineCounts,i),j(w.commentStageSize,i).height/n.doubleResized[t]),f=e.lineCount;if(e.lineHeight||(e.lineHeight=h),e.charSize||(e.charSize=m),e.fontSize=.8*e.charSize,this.context.font=O(e.font,e.fontSize),e.resized||e.ender||!("big"===e.size&&f>2||"medium"===e.size&&f>4||"small"===e.size&&f>6)){r=(u=T(e,this.context)).height,o=u.width,c=u.itemWidth}else{e.fontSize=l[e.size].resized;var u,d=Y(e.size,!1,!0);e.charSize=e.charSize*(d/e.lineHeight),e.lineHeight=d,e.resized=!0,e.resizedY=!0,r=(u=T(e,this.context)).height,o=u.width,c=u.itemWidth}if("naka"!==e.loc&&o>a){var g=a/o;e.resizedX=!0;var v=p({},e);v.charSize=(v.charSize||0)*g,v.lineHeight=(v.lineHeight||0)*g,v.fontSize=.8*v.charSize;var b=T(v,this.context);if(b.width>a)for(;b.width>=a;){var z=v.charSize;v.charSize-=1,v.lineHeight*=v.charSize/z,v.fontSize=.8*v.charSize,b=T(v,this.context)}else{for(var y=p({},v);b.width<a;){y=p({},v);z=v.charSize;v.charSize+=1,v.lineHeight*=v.charSize/z,v.fontSize=.8*v.charSize,b=T(v,this.context)}v=y}if(e.resizedY){var S=(v.charSize||0)/e.charSize;e.charSize=S*m,e.lineHeight=S*h}else e.charSize=v.charSize,e.lineHeight=v.lineHeight;e.fontSize=.8*(e.charSize||0),o=(b=T(e,this.context)).width,r=b.height,c=b.itemWidth}for(var x=0;x<e.content.length;x++){var C=e.content[x];C&&c&&(C.width=c[x])}return e.fontSize=.8*(e.charSize||0),G(e.charSize||0).scale<1&&(r*=1.01),{width:o*s,height:r*s,resized:!!e.resized,fontSize:e.fontSize,lineHeight:e.lineHeight||0,content:e.content,resizedX:!!e.resizedX,resizedY:!!e.resizedY,charSize:e.charSize||0}},e.prototype.getCommentSize=function(e){this.context.font=O(e.font,e.fontSize);var t=e;if(e.invisible)return t.height=0,t.width=0,t.lineHeight=0,t.fontSize=0,t.content=[],t.resized=!1,t.resizedX=!1,t.resizedY=!1,t.charSize=0,t;var i=this.measureText(e);return 1!==z.scale&&-1===t.layer&&(i.height*=z.scale,i.width*=z.scale,i.fontSize*=z.scale),t.height=i.height,t.width=i.width,t.lineHeight=i.lineHeight,t.fontSize=i.fontSize,t.content=i.content,t.resized=i.resized,t.resizedX=i.resizedX,t.resizedY=i.resizedY,t.charSize=i.charSize,t},e.prototype.draw=function(e,t,i){for(var n,o=!1,r=0,c=k.reverse;r<c.length;r++){if("コメ"===(l=c[r]).target&&this.comment.owner||"投コメ"===l.target&&!this.comment.owner)break;l.start<e&&e<l.end&&(o=!0)}for(var a=0,s=k.ban;a<s.length;a++){var l;if((l=s[a]).start<e&&e<l.end)return}var h=(w.canvasWidth-this.comment.width)/2,m=this.posY;if("naka"===this.comment.loc){if((h=o?w.canvasWidth+this.comment.width-H(this.comment.width,e-this.comment.vpos,this.comment.long):H(this.comment.width,e-this.comment.vpos,this.comment.long))>w.canvasWidth||h+this.comment.width<0)return}else"shita"===this.comment.loc&&(m=w.canvasHeight-this.posY-this.comment.height);if(void 0===this.image&&(this.image=this.getTextImage()),this.image&&(this.comment._live?this.context.globalAlpha=w.contextFillLiveOpacity:this.context.globalAlpha=1,this.context.drawImage(this.image,h,m)),t){var f=j(w.commentScale,!1);this.context.strokeStyle="rgba(0,255,255,1)",this.context.strokeRect(h,m,this.comment.width,this.comment.height);for(var u=0;u<this.comment.lineCount;u++){var d=(this.comment.lineHeight*(u+1)+(this.comment.charSize-this.comment.lineHeight)/2+-.16*this.comment.lineHeight+((null===(n=w.fonts[this.comment.font])||void 0===n?void 0:n.offset)||0))*f;this.context.strokeStyle="rgba(255,255,0,0.5)",this.context.strokeRect(h,m+d,this.comment.width,-1*this.comment.fontSize*f)}}if(i){var g=this.context.font,p=this.context.fillStyle;this.context.font=O("defont",30),this.context.fillStyle="#ff00ff",this.context.fillText(this.comment.mail.join(","),h,m+30),this.context.font=g,this.context.fillStyle=p}},e.prototype.getTextImage=function(){var e,t=this;if(this.comment.invisible||1===this.comment.lineCount&&0===this.comment.width||this.comment.height-(this.comment.charSize-this.comment.lineHeight)<=0)return null;var i=JSON.stringify(this.comment.content)+"@@HTML5@@"+v([],this.comment.mail,!0).sort().join(","),n=L[i];if(n)return this.image=n.image,window.setTimeout((function(){delete t.image}),10*this.comment.long+w.cacheAge),clearTimeout(n.timeout),n.timeout=window.setTimeout((function(){delete L[i]}),10*this.comment.long+w.cacheAge),n.image;if(this.image)return this.image;var o=document.createElement("canvas");o.width=this.comment.width+4*this.comment.charSize,o.height=this.comment.height-(this.comment.charSize-this.comment.lineHeight);var r=o.getContext("2d");if(!r)throw new Error("Fail to get CanvasRenderingContext2D");r.strokeStyle=N(this.comment),r.textAlign="start",r.textBaseline="alphabetic",r.lineWidth=w.contextLineWidth;var c=G(this.comment.charSize),a=c.fontSize,s=c.scale;r.font=O(this.comment.font,a);var l=j(w.commentScale,!1)*s*(-1===this.comment.layer?z.scale:1);r.scale(l,l),r.fillStyle=this.comment.color;for(var h=0,m=0,f=(10-10*s)*(this.comment.lineCount/w.hiResCommentCorrection),u=0;u<this.comment.content.length;u++){var d=this.comment.content[u];if(d)for(var g=d.content.split("\n"),p=0;p<g.length;p++){var b=g[p];if(void 0!==b){var y=(this.comment.lineHeight*(m+1+f)+(this.comment.charSize-this.comment.lineHeight)/2+-.16*this.comment.lineHeight+((null===(e=w.fonts[this.comment.font])||void 0===e?void 0:e.offset)||0))/s;r.strokeText(b,h,y),r.fillText(b,h,y),p<g.length-1?(h=0,m+=1):h+=d.width[p]||0}}}return this.image=o,window.setTimeout((function(){delete t.image}),10*this.comment.long+w.cacheAge),L[i]={timeout:window.setTimeout((function(){delete L[i]}),10*this.comment.long+w.cacheAge),image:o},o},e}(),I=function(){function e(e,t){this.context=t,this.scale=1,this.scaleX=1,this._globalScale=j(w.commentScale,!0),this.posY=0,e.content=e.content.replace(/\t/g,"  "),this.comment=this.getCommentSize(this.parseCommandAndNicoscript(e))}return Object.defineProperty(e.prototype,"invisible",{get:function(){return this.comment.invisible},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loc",{get:function(){return this.comment.loc},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"long",{get:function(){return this.comment.long},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vpos",{get:function(){return this.comment.vpos},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.comment.width},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.comment.height},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"flash",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"layer",{get:function(){return this.comment.layer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"owner",{get:function(){return this.comment.owner},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mail",{get:function(){return this.comment.mail},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lineCount",{get:function(){return this.comment.lineCount},enumerable:!1,configurable:!0}),e.prototype.parseCommand=function(e){for(var t={loc:void 0,size:void 0,fontSize:void 0,color:void 0,font:void 0,full:!1,ender:!1,_live:!1,invisible:!1,long:void 0},i=0,n=e.mail;i<n.length;i++){var r=n[i],c=(r=r.toLowerCase()).match(/^@([0-9.]+)/);if(c&&c[1])t.long=Number(c[1]);else if(void 0===t.loc&&o.comment.loc(r))t.loc=r;else if(void 0===t.size&&o.comment.size(r))t.size=r,t.fontSize=j(w.fontSize,!0)[r].default;else{if(void 0===t.color){var a=w.colors[r];if(a){t.color=a;continue}var s=r.match(/#[0-9a-z]{3,6}/);if(s&&s[0]&&e.premium){t.color=s[0].toUpperCase();continue}}void 0===t.font&&o.comment.font(r)?t.font=r:o.comment.command.key(r)&&(t[r]=!0)}}return t},e.prototype.parseCommandAndNicoscript=function(e){for(var t,i,n=M(e),o=[],r=(e.content.match(/\n|[^\n]+/g)||[]).map((function(e){return Array.from(e.match(/[ -~｡-ﾟ]+|[^ -~｡-ﾟ]+/g)||[])})),c={simsunStrong:new RegExp(w.flashChar.simsunStrong),simsunWeak:new RegExp(w.flashChar.simsunWeak),gulim:new RegExp(w.flashChar.gulim),gothic:new RegExp(w.flashChar.gothic)},a=function(e){return e.match("^simsun.+")?"simsun":"gothic"===e?"defont":e},s=function(e){for(var t=[],i=0,n=e;i<n.length;i++){var r=n[i];if(null===r.match(/[ -~｡-ﾟ]+/g)){var s=[],l=void 0;if(null!==(l=c.simsunStrong.exec(r))&&s.push({font:"simsunStrong",index:l.index}),null!==(l=c.simsunWeak.exec(r))&&s.push({font:"simsunWeak",index:l.index}),null!==(l=c.gulim.exec(r))&&s.push({font:"gulim",index:l.index}),null!==(l=c.gothic.exec(r))&&s.push({font:"gothic",index:l.index}),0===s.length)t.push({content:r});else if(1===s.length&&s[0])t.push({content:r,font:a(s[0].font)});else if(s.sort((function(e,t){return e.index>t.index?1:e.index<t.index?-1:0})),"xp"===w.flashMode){for(var h=0,m=1;m<s.length;m++){var f=s[m],u=s[m-1];void 0!==f&&void 0!==u&&(t.push({content:r.slice(h,f.index),font:a(u.font)}),h=f.index)}var d=s[s.length-1];d&&t.push({content:r.slice(h),font:a(d.font)})}else{var g=s[0],p=s[1];if(!g||!p){t.push({content:r});continue}"gothic"!==g.font?t.push({content:r,font:a(g.font)}):(t.push({content:r.slice(0,p.index),font:a(g.font)}),t.push({content:r.slice(p.index),font:a(p.font)}))}}else t.push({content:r})}var v=t[0];v&&v.font?o.push.apply(o,t.map((function(e){return e.font||(e.font=v.font),e}))):o.push.apply(o,t)},l=0,h=r;l<h.length;l++){s(h[l])}var m=o[0];m&&m.font&&(n.font=m.font);var f=o.reduce((function(e,t){var i;return e+((null===(i=t.content.match(/\n/g))||void 0===i?void 0:i.length)||0)}),1),u=-1*((null===(t=e.content.match(new RegExp(w.flashScriptChar.super,"g")))||void 0===t?void 0:t.length)||0)*w.scriptCharOffset+((null===(i=e.content.match(new RegExp(w.flashScriptChar.sub,"g")))||void 0===i?void 0:i.length)||0)*w.scriptCharOffset;return p(p({},n),{content:o,lineCount:f,lineOffset:u})},e.prototype.measureText=function(e){var t=j(w.lineHeight,!0),i=j(w.fontSize,!0),n=e.lineCount;e.lineHeight||(e.lineHeight=t[e.size].default),e.resized||e.ender||("big"===e.size&&n>2||"medium"===e.size&&n>4||"small"===e.size&&n>6)&&(e.fontSize=i[e.size].resized,e.lineHeight=t[e.size].resized,e.resized=!0,e.resizedY=!0,this.context.font=O(e.font,e.fontSize));for(var o=[],r=[],c=0,a=0,s=0;s<e.content.length;s++){var l=e.content[s];if(void 0!==l){var h=l.content.split("\n"),m=[];this.context.font=O(l.font||e.font,e.fontSize);for(var f=0;f<h.length;f++){var u=h[f];if(void 0!==u){var d=this.context.measureText(u);c+=d.width,a+=d.width+Math.max(u.length-1,0)*w.letterSpacing,m.push(d.width),f<h.length-1&&(o.push(c),r.push(a),a=0,c=0)}}o.push(c),r.push(a),l.width=m}}var g=function(){for(var e=0,t=-1,i=0,n=r.length;i<n;i++){var o=r[i];o&&e<o&&(e=o,t=i)}return{max:e,index:t}}(),p=g.max;this.scaleX=g.max/(o[g.index]||1);var v=p*this.scale,b=(e.fontSize*e.lineHeight*n+w.commentYPaddingTop[e.resizedY?"resized":"default"])*this.scale;if("naka"!==e.loc){var z=j(w.commentStageSize,!0)[e.full?"fullWidth":"width"];if(v>z&&!e.resizedX)return e.fontSize=i[e.size].default,e.lineHeight=t[e.size].default,this.scale=z/v,e.resizedX=!0,e.resized=!0,this.measureText(e)}return{width:v,charSize:0,height:b,resized:!!e.resized,fontSize:e.fontSize,lineHeight:e.lineHeight,content:e.content,resizedX:!!e.resizedX,resizedY:!!e.resizedY}},e.prototype.getCommentSize=function(e){this.context.font=O(e.font,e.fontSize);var t=e;if(e.invisible)return t.height=0,t.width=0,t.lineHeight=0,t.fontSize=0,t.content=[],t.resized=!1,t.resizedX=!1,t.resizedY=!1,t.charSize=0,t;var i=this.measureText(e);return 1!==z.scale&&-1===t.layer&&(i.height*=z.scale,i.width*=z.scale),t.height=i.height*this._globalScale,t.width=i.width*this._globalScale,t.lineHeight=i.lineHeight,t.fontSize=i.fontSize,t.content=i.content,t.resized=i.resized,t.resizedX=i.resizedX,t.resizedY=i.resizedY,t.charSize=i.charSize,t},e.prototype.draw=function(e,t,i){for(var n=!1,o=0,r=k.reverse;o<r.length;o++){if("コメ"===(s=r[o]).target&&this.comment.owner||"投コメ"===s.target&&!this.comment.owner)break;s.start<e&&e<s.end&&(n=!0)}for(var c=0,a=k.ban;c<a.length;c++){var s;if((s=a[c]).start<e&&e<s.end)return}var l=(w.canvasWidth-this.comment.width)/2,h=this.posY;if("naka"===this.comment.loc){if((l=n?w.canvasWidth+this.comment.width-H(this.comment.width,e-this.comment.vpos,this.comment.long):H(this.comment.width,e-this.comment.vpos,this.comment.long))>w.canvasWidth||l+this.comment.width<0)return}else"shita"===this.comment.loc&&(h=w.canvasHeight-this.posY-this.comment.height);if(void 0===this.image&&(this.image=this.getTextImage()),this.image&&(this.comment._live?this.context.globalAlpha=w.contextFillLiveOpacity:this.context.globalAlpha=1,this.context.drawImage(this.image,l,h)),t){this.context.strokeStyle="rgba(255,0,255,1)",this.context.strokeRect(l,h,this.comment.width,this.comment.height);for(var m=0;m<this.comment.lineCount;m++){var f=((m+1)*(this.comment.fontSize*this.comment.lineHeight)+w.commentYPaddingTop[this.comment.resizedY?"resized":"default"])*this.scale;this.context.strokeStyle="rgba(255,255,0,0.25)",this.context.strokeRect(l,h+f*this._globalScale,this.comment.width,this.comment.fontSize*this.comment.lineHeight*-1*this._globalScale*this.scale*(-1===this.comment.layer?z.scale:1))}}if(i){var u=this.context.font,d=this.context.fillStyle;this.context.font=O("defont",30),this.context.fillStyle="#ff00ff",this.context.fillText(this.comment.mail.join(","),l,h+30),this.context.font=u,this.context.fillStyle=d}},e.prototype.getTextImage=function(){var e=this;if(this.comment.invisible||1===this.comment.lineCount&&0===this.comment.width||this.comment.height-(this.comment.charSize-this.comment.lineHeight)<=0)return null;var t=JSON.stringify(this.comment.content)+"@@FLASH@@"+v([],this.comment.mail,!0).sort().join(","),i=L[t];if(i)return this.image=i.image,window.setTimeout((function(){delete e.image}),10*this.comment.long+w.cacheAge),clearTimeout(i.timeout),i.timeout=window.setTimeout((function(){delete L[t]}),10*this.comment.long+w.cacheAge),i.image;var n=document.createElement("canvas");n.width=this.comment.width,n.height=this.comment.height;var o=n.getContext("2d");if(!o)throw new Error("Fail to get CanvasRenderingContext2D");o.strokeStyle=N(this.comment),o.textAlign="start",o.textBaseline="alphabetic",o.lineWidth=4,o.font=O(this.comment.font,this.comment.fontSize),o.scale(this._globalScale*this.scale*(-1===this.comment.layer?z.scale:1)*this.scaleX,this._globalScale*this.scale*(-1===this.comment.layer?z.scale:1)),o.fillStyle=this.comment.color;for(var r=this.comment.lineOffset,c=this.comment.font,a=0,s=0,l=0;l<this.comment.content.length;l++){var h=this.comment.content[l];if(h){c!==(h.font||this.comment.font)&&(c=h.font||this.comment.font,o.font=O(c,this.comment.fontSize));for(var m=h.content.split("\n"),f=0;f<m.length;f++){var u=m[f];if(void 0!==u){var d=(r+s+1)*(this.comment.fontSize*this.comment.lineHeight)+w.commentYPaddingTop[this.comment.resizedY?"resized":"default"]+this.comment.fontSize*this.comment.lineHeight*w.commentYOffset[this.comment.size][this.comment.resizedY?"resized":"default"];o.strokeText(u,a,d),o.fillText(u,a,d),f<m.length-1?(a=0,s+=1):a+=h.width[f]||0}}}}return this.image=n,window.setTimeout((function(){delete e.image}),10*this.comment.long+w.cacheAge),L[t]={timeout:window.setTimeout((function(){delete L[t]}),10*this.comment.long+w.cacheAge),image:n},n},e}(),X=[],D=!1,B=function(){function t(t,i,n){void 0===n&&(n={});var r,c,d,g=performance.now();if(c=(r=navigator.userAgent).match(/windows nt 6\.[12]/i)?"win7":r.match(/windows nt (6\.3|10\.\d+)/i)?"win8_1":r.match(/windows nt/i)?"win":r.match(/mac os x 10(.|_)(9|10)/i)?"mac10_9":r.match(/mac os x 10(.|_)\d{2}/i)?"mac10_11":r.match(/mac os x/i)?"mac":"other",b={colors:e,contextStrokeColor:"#000000",contextStrokeInversionColor:"#FFFFFF",contextStrokeOpacity:.4,contextFillLiveOpacity:.5,contextLineWidth:2.8,commentScale:{html5:1920/683,flash:1920/683},commentStageSize:{html5:{width:512,fullWidth:683,height:384},flash:{width:512,fullWidth:640,height:385}},fontSize:{html5:{small:{default:18,resized:10},medium:{default:27,resized:14},big:{default:39,resized:19.5}},flash:{small:{default:15,resized:7.5},medium:{default:24,resized:12},big:{default:39,resized:19.5}}},lineCounts:{default:{big:8.4,medium:13.1,small:21},resized:{big:16,medium:25.4,small:38},doubleResized:{big:7.8,medium:11.3,small:16.6}},hiResCommentCorrection:20,minFontSize:10,fonts:x[c],fpsInterval:500,cacheAge:2e3,canvasWidth:1920,canvasHeight:1080,commentDrawRange:1530,commentDrawPadding:195,collisionRange:{left:235,right:1685},sameCARange:3600,sameCAGap:100,sameCAMinScore:10,plugins:[],flashThreshold:1499871600,flashChar:{gulim:"[ĦħĲĳĸĿŀŉ-ŋŦŧː˚⁴ⁿ₁-₄ℓ⅓⅔⅜-⅞↔↕∼⒜-⒵ⓐ-ⓩ▣-▩▶▷◀◁◈◐◑☎☏☜☞♠♡♣-♥♧-♩♬ㄱ-ㅮ㈀-㈜㉠-㉻㎀-㎄㎈-㎍㎐-㎛㎟㎠㎢-㏊㏏㏐㏓㏖㏘㏛-㏝豈-廊浪-璉練廓￦]",simsunStrong:"[ǎǐǒǔǖǘǚǜɑɡˊˋ‖‵ⅪⅫ∣∶∷≌≮≯⊕⒃-⒛┄-┋╭-╳▁-▃▅-▇▉-▋▍-▏▔▕◢-◥☉〖〗〞〡-〩ㄅ-ㄩ㈠-㈩㊣㏎㏑㏒㏕-兀嗀︰︱︳-﹄﹉-﹒﹔-﹗﹙-﹦﹨-﹫]",simsunWeak:"[ˉ℅℉↖-↙∏∕≈≤≥⊙⑴-⒂┍┎┑┒┕┖┙┚┞┟┡┢┦┧┩┪┭┮┱┲┵┶┹┺┽┾╀╁╃-╊═-╬▄█▌▓]",gothic:"[ϻﾟ]"},flashMode:"vista",flashScriptChar:{super:"[ª²³¹ºʰʲʳʷʸˡ-ˣ̄ᴬ-ᵃᵅ-ᵡᶛ-ᶡᶣ-ᶿ⁰ⁱ⁴-ⁿⱽ]",sub:"[̠ᵢ-ᵪ₀-₎ₐ-ₜⱼ]"},font:{gulim:'normal 600 [size]px gulim, "Microsoft JhengHei UI", Arial, "ＭＳ Ｐゴシック", "MS PGothic", MSPGothic, MS-PGothic',simsun:'normal 400 [size]px simsun, "游明朝体", "游明朝", "Yu Mincho", YuMincho, yumincho, YuMin-Medium'},lineHeight:{small:{default:1.2,resized:10/7.5},medium:{default:1.16,resized:1.25},big:{default:45/39,resized:24/19.5}},doubleResizeMaxWidth:{full:1200,normal:960},commentYPaddingTop:{default:5,resized:3},commentYMarginBottom:{small:.24,medium:.28,big:.24},commentYOffset:{small:{default:-.2,resized:-.2},medium:{default:-.2,resized:-.2},big:{default:-.2,resized:-.2}},letterSpacing:1,scriptCharOffset:.12},!o.config.initOptions(n))throw new Error("Please see document: https://xpadev-net.github.io/niconicomments/#p_options");d=Object.assign(C,n),z=d,function(e){w=e}(Object.assign(b,z.config)),D=z.debug,L={},k={reverse:[],default:[],replace:[],ban:[]},this.canvas=t;var p=t.getContext("2d");if(!p)throw new Error("Fail to get CanvasRenderingContext2D");this.context=p,this.context.strokeStyle="rgba(".concat(_(w.contextStrokeColor).join(","),",").concat(w.contextStrokeOpacity,")"),this.context.textAlign="start",this.context.textBaseline="alphabetic",this.context.lineWidth=w.contextLineWidth;var v=z.format;z.formatted&&console.warn("Deprecated: options.formatted is no longer recommended. Please use options.format. https://xpadev-net.github.io/niconicomments/#p_format"),"default"===v&&(v=z.formatted?"formatted":"legacy"),z.useLegacy&&console.warn("Deprecated: options.useLegacy is no longer recommended. Please use options.mode. https://xpadev-net.github.io/niconicomments/#p_mode"),"default"===z.mode&&z.useLegacy&&(z.mode="html5");var y,S=function(e,t){var i=[];if("empty"===t&&void 0===e)return[];if("XMLDocument"!==t&&"niconicome"!==t||!o.xmlDocument(e))if("formatted"===t&&o.formatted.legacyComments(e))i=s(e);else if("legacy"===t&&o.legacy.rawApiResponses(e))i=l(e);else if("legacyOwner"===t&&o.legacyOwner.comments(e))i=h(e);else if("owner"===t&&o.owner.comments(e))i=m(e);else{if("v1"!==t||!o.v1.threads(e))throw new Error("unknown input format");i=f(e)}else i=a(e);return u(i)}(i,v);y=w.plugins.map((function(e){return new e(t,S)})),X=y,this.video=z.video||void 0,this.showCollision=z.showCollision,this.showFPS=z.showFPS,this.showCommentCount=z.showCommentCount,this.enableLegacyPiP=z.enableLegacyPiP,this.timeline={},this.collision=["ue","shita","right","left"].reduce((function(e,t){return e[t]=[],e}),{}),this.lastVpos=-1,this.preRendering(S),$("constructor complete: ".concat(performance.now()-g,"ms"))}return t.prototype.preRendering=function(e){var t=this,i=performance.now();z.keepCA&&(e=function(e){for(var t={},i=[],n={},o=0,r=e;o<r.length;o++)if(void 0!==(h=r[o]).user_id&&-1!==h.user_id){void 0===t[h.user_id]&&(t[h.user_id]=0),(h.mail.indexOf("ca")>-1||h.mail.indexOf("patissier")>-1||h.mail.indexOf("ender")>-1||h.mail.indexOf("full")>-1)&&(t[h.user_id]+=5),(h.content.match(/\r\n|\n|\r/g)||[]).length>2&&(t[h.user_id]+=(h.content.match(/\r\n|\n|\r/g)||[]).length/2);var c="".concat(h.content,"@@").concat(v([],h.mail,!0).sort().filter((function(e){return!e.match(/@[\d.]+|184|device:.+|patissier|ca/)})).join("")),a=n[c];void 0!==a?(h.vpos-a.vpos>w.sameCAGap||Math.abs(h.date-a.date)<w.sameCARange)&&(i.push(h),n[c]=h):(i.push(h),n[c]=h)}for(var s=0,l=i;s<l.length;s++){var h;(t[(h=l[s]).user_id]||0>=w.sameCAMinScore)&&(h.layer=h.user_id)}return i}(e)),this.getCommentPos(e.reduce((function(e,i){return A(i)?e.push(new I(i,t.context)):e.push(new E(i,t.context)),e}),[])),this.sortComment(),$("preRendering complete: ".concat(performance.now()-i,"ms"))},t.prototype.getCommentPos=function(e){var t=this,i=performance.now();return e.forEach((function(e){if(!e.invisible)if("naka"===e.loc){var i=0,n=Math.round(-288/((1632+e.width)/(e.long+125)))-100;if(w.canvasHeight<e.height)i=(e.height-w.canvasHeight)/-2;else for(var o=!1,r=!0,c=0;r&&c<10;){r=!1,c++;for(var a=n;a<e.long+125;a++){var s=e.vpos+a;if((l=H(e.width,a,e.long))+e.width>=w.collisionRange.right&&l<=w.collisionRange.right)if(i=(m=P(i,e,t.collision.right[s])).currentPos,r=m.isChanged,o=m.isBreak)break;if(l+e.width>=w.collisionRange.left&&l<=w.collisionRange.left)if(i=(m=P(i,e,t.collision.left[s])).currentPos,r=m.isChanged,o=m.isBreak)break}if(o)break}for(a=n;a<e.long+125;a++){s=e.vpos+a;var l=H(e.width,a,e.long);F(t.timeline,s,e),l+e.width>=w.collisionRange.right&&l<=w.collisionRange.right&&F(t.collision.right,s,e),l+e.width>=w.collisionRange.left&&l<=w.collisionRange.left&&F(t.collision.left,s,e)}e.posY=i}else{i=0,r=!0,c=0;var h=void 0;for(h="ue"===e.loc?t.collision.ue:t.collision.shita;r&&c<10;){r=!1,c++;for(a=0;a<e.long;a++){var m;if(i=(m=P(i,e,h[e.vpos+a])).currentPos,r=m.isChanged,m.isBreak)break}}for(a=0;a<e.long;a++){s=e.vpos+a;F(t.timeline,s,e),a>e.long-20||("ue"===e.loc?F(t.collision.ue,s,e):F(t.collision.shita,s,e))}e.posY=i}})),$("getCommentPos complete: ".concat(performance.now()-i,"ms")),e},t.prototype.sortComment=function(){for(var e=performance.now(),t=0,i=Object.keys(this.timeline);t<i.length;t++){var n=i[t],o=this.timeline[Number(n)];if(o){for(var r=[],c=[],a=0,s=o;a<s.length;a++){var l=s[a];(null==l?void 0:l.owner)?r.push(l):c.push(l)}this.timeline[Number(n)]=c.concat(r)}}$("parseData complete: ".concat(performance.now()-e,"ms"))},t.prototype.addComments=function(){for(var e,t,i,n=this,o=[],r=0;r<arguments.length;r++)o[r]=arguments[r];X.forEach((function(e){return e.addComments(o)}));for(var c=o.reduce((function(e,t){return A(t)?e.push(new I(t,n.context)):e.push(new E(t,n.context)),e}),[]),a=function(n){if(n.invisible)return"continue";if("naka"===n.loc){var o=0,r=Math.round(-288/((1632+n.width)/(n.long+125)))-100;if(w.canvasHeight<n.height)o=(n.height-w.canvasHeight)/-2;else for(var c=!1,a=!0,l=0;a&&l<10;){a=!1,l++;for(var h=r;h<n.long+125;h++){var m=n.vpos+h;if((u=H(n.width,h,n.long))+n.width>=w.collisionRange.right&&u<=w.collisionRange.right){var f=null===(e=s.collision.right[m])||void 0===e?void 0:e.filter((function(e){return e.vpos<=n.vpos}));if(o=(d=P(o,n,f)).currentPos,a=d.isChanged,c=d.isBreak)break}if(u+n.width>=w.collisionRange.left&&u<=w.collisionRange.left){f=null===(t=s.collision.left[m])||void 0===t?void 0:t.filter((function(e){return e.vpos<=n.vpos}));if(o=(d=P(o,n,f)).currentPos,a=d.isChanged,c=d.isBreak)break}}if(c)break}for(h=r;h<n.long+125;h++){m=n.vpos+h;var u=H(n.width,h,n.long);F(s.timeline,m,n),u+n.width>=w.collisionRange.right&&u<=w.collisionRange.right&&F(s.collision.right,m,n),u+n.width>=w.collisionRange.left&&u<=w.collisionRange.left&&F(s.collision.left,m,n)}n.posY=o}else{o=0,a=!0,l=0,f=void 0;for(f="ue"===n.loc?s.collision.ue:s.collision.shita;a&&l<10;){a=!1,l++;for(h=0;h<n.long;h++){var d;if(o=(d=P(o,n,null===(i=f[n.vpos+h])||void 0===i?void 0:i.filter((function(e){return e.vpos<=n.vpos})))).currentPos,a=d.isChanged,d.isBreak)break}}for(h=0;h<n.long;h++){m=n.vpos+h;F(s.timeline,m,n),h>n.long-20||("ue"===n.loc?F(s.collision.ue,m,n):F(s.collision.shita,m,n))}n.posY=o}},s=this,l=0,h=c;l<h.length;l++){var m=h[l];a(m)}},t.prototype.drawCanvas=function(e,t){var i,n,o;void 0===t&&(t=!1);var r=performance.now();if(this.lastVpos===e&&!t)return!1;var c=this.timeline[e];if(!t&&0===(null==c?void 0:c.filter((function(e){return"naka"===e.loc})).length)&&0===(null===(n=null===(i=this.timeline[this.lastVpos])||void 0===i?void 0:i.filter((function(e){return"naka"===e.loc})))||void 0===n?void 0:n.length)&&function(e,t){if(e.length!==t.length)return!1;for(var i=0,n=e.length;i<n;++i)if(e[i]!==t[i])return!1;return!0}(c.filter((function(e){return"naka"!==e.loc})),(null===(o=this.timeline[this.lastVpos])||void 0===o?void 0:o.filter((function(e){return"naka"!==e.loc})))||[]))return!1;if(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.lastVpos=e,this.video){var a=void 0,s=this.canvas.height/this.video.videoHeight,l=this.canvas.width/this.video.videoWidth;a=(this.enableLegacyPiP?s>l:s<l)?l:s;var h=.5*(this.canvas.width-this.video.videoWidth*a),m=.5*(this.canvas.height-this.video.videoHeight*a);this.context.drawImage(this.video,h,m,this.video.videoWidth*a,this.video.videoHeight*a)}if(this.showCollision){var f=this.collision.left[e],u=this.collision.right[e];if(this.context.fillStyle="red",f)for(var d=0,g=f;d<g.length;d++){var p=g[d];this.context.fillRect(w.collisionRange.left,p.posY,w.contextLineWidth,p.height)}if(u)for(var v=0,b=u;v<b.length;v++){p=b[v];this.context.fillRect(w.collisionRange.right,p.posY,-1*w.contextLineWidth,p.height)}}if(c)for(var z=0,y=c;z<y.length;z++){(p=y[z]).invisible||p.draw(e,this.showCollision,D)}if(X.forEach((function(t){return t.draw(e)})),this.showFPS){this.context.font=O("defont",60),this.context.fillStyle="#00FF00",this.context.strokeStyle="rgba(".concat(_(w.contextStrokeColor).join(","),",").concat(w.contextStrokeOpacity,")");var S=Math.floor(performance.now()-r),x=Math.floor(1e3/(0===S?1:S));this.context.strokeText("FPS:".concat(x,"(").concat(S,"ms)"),100,100),this.context.fillText("FPS:".concat(x,"(").concat(S,"ms)"),100,100)}return this.showCommentCount&&(this.context.font=O("defont",60),this.context.fillStyle="#00FF00",this.context.strokeStyle="rgba(".concat(_(w.contextStrokeColor).join(","),",").concat(w.contextStrokeOpacity,")"),c?(this.context.strokeText("Count:".concat(c.length),100,200),this.context.fillText("Count:".concat(c.length),100,200)):(this.context.strokeText("Count:0",100,200),this.context.fillText("Count:0",100,200))),$("drawCanvas complete: ".concat(performance.now()-r,"ms")),!0},t.prototype.clear=function(){this.context.clearRect(0,0,w.canvasWidth,w.canvasHeight)},t.typeGuard=o,t.default=t,t}(),$=function(e){D&&console.debug(e)};return B}));
//# sourceMappingURL=/sm/88ebeb6368792cc7cae2754b2faf9608340efb4cf286ccc4008a9fd6d2c44c32.map